{% extends 'base.html' %}

{% block content %}
<style>
/* Estilos compactos para el formulario */
.registro-compact .card-minimal { padding: 1rem; }
.registro-compact .form-label.required::after { content: ' *'; color: #ffc107; margin-left: 0.25rem; }
.registro-compact .form-control { padding: 0.4rem 0.6rem; font-size: 0.9rem; }
.registro-compact .mb-3 { margin-bottom: 0.5rem !important; }
.registro-compact h2 { font-size: 1.2rem; margin-bottom: 0.3rem; }
.registro-compact p { margin-bottom: 0.3rem; font-size: 0.85rem; }
</style>

<div class="container registro-compact mt-3 pt-2">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="card-minimal p-3">
        <div class="text-center mb-2">
          <h2 class="text-gold">Unirse a la Comunidad</h2>
          <p class="text-muted small">Crea tu cuenta para comenzar tu journey espiritual</p>
          <p class="text-muted small">Todos los campos son obligatorios <span class="text-warning">(*)</span></p>
        </div>

        {% if errores.general %}
          <div class="alert alert-danger">{{ errores.general }}</div>
        {% endif %}

        <form method="post" novalidate>
          {% csrf_token %}

          <!-- RUT -->
          <div class="mb-3">
            <label for="rut" class="form-label text-light required">RUT</label>
            <input type="text" id="rut" name="rut" class="form-control bg-dark text-light border-minimal"
                   required placeholder="12.345.678-5" value="{{ data.rut|default:'' }}">
            {% if errores.rut %}<span class="text-danger small">{{ errores.rut }}</span>{% endif %}
          </div>

          <!-- Nombre + Apellido -->
          <div class="row">
            <div class="col-6 mb-3">
              <label for="first_name" class="form-label text-light required">Nombre</label>
              <input type="text" id="first_name" name="first_name" class="form-control bg-dark text-light border-minimal"
                     required placeholder="Tu nombre" value="{{ data.first_name|default:'' }}">
              {% if errores.first_name %}<span class="text-danger small">{{ errores.first_name }}</span>{% endif %}
            </div>
            <div class="col-6 mb-3">
              <label for="last_name" class="form-label text-light required">Apellido</label>
              <input type="text" id="last_name" name="last_name" class="form-control bg-dark text-light border-minimal"
                     required placeholder="Tu apellido" value="{{ data.last_name|default:'' }}">
              {% if errores.last_name %}<span class="text-danger small">{{ errores.last_name }}</span>{% endif %}
            </div>
          </div>

          <!-- Usuario -->
          <div class="mb-3">
            <label for="username" class="form-label text-light required">Nombre de usuario</label>
            <input type="text" id="username" name="username" class="form-control bg-dark text-light border-minimal"
                   required placeholder="Elige un usuario" value="{{ data.username|default:'' }}">
            {% if errores.username %}<span class="text-danger small">{{ errores.username }}</span>{% endif %}
          </div>

          <!-- Email -->
          <div class="mb-3">
            <label for="email" class="form-label text-light required">Email</label>
            <input type="email" id="email" name="email" class="form-control bg-dark text-light border-minimal"
                   required placeholder="tu@email.com" value="{{ data.email|default:'' }}">
            {% if errores.email %}<span class="text-danger small">{{ errores.email }}</span>{% endif %}
          </div>

          <!-- Contrase√±a -->
          <div class="mb-3">
            <label for="password1" class="form-label text-light required">Contrase√±a</label>
            <div class="input-group">
              <input type="password" id="password1" name="password1"
                     class="form-control bg-dark text-light border-minimal"
                     required placeholder="Crea una contrase√±a segura">
              <button type="button" class="btn btn-outline-light toggle-password" data-target="password1">üëÅ</button>
            </div>
          </div>

          <!-- Confirmar Contrase√±a -->
          <div class="mb-3">
            <label for="password2" class="form-label text-light required">Confirmar contrase√±a</label>
            <div class="input-group">
              <input type="password" id="password2" name="password2"
                     class="form-control bg-dark text-light border-minimal"
                     required placeholder="Repite tu contrase√±a">
              <button type="button" class="btn btn-outline-light toggle-password" data-target="password2">üëÅ</button>
            </div>
            {% if errores.password %}<span class="text-danger small">{{ errores.password }}</span>{% endif %}
          </div>

          <button type="submit" class="btn-gold w-100 py-2">Crear Cuenta</button>
        </form>

        <div class="text-center mt-2">
          <p class="text-muted small">¬øYa tienes cuenta?
            <a href="{% url 'usuarios:login' %}" class="text-gold text-decoration-none">Inicia sesi√≥n aqu√≠</a>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Formato autom√°tico de RUT
  const rutInput = document.getElementById('rut');
  if (rutInput) {
    rutInput.addEventListener('input', function() {
      let raw = this.value;
      let valor = (raw.match(/[0-9kK]/g) || []).join('').toUpperCase();
      let cuerpo = valor.slice(0, -1);
      let dv = valor.slice(-1);
      let cuerpoFormateado = '';
      while (cuerpo.length > 3) {
        cuerpoFormateado = '.' + cuerpo.slice(-3) + cuerpoFormateado;
        cuerpo = cuerpo.slice(0, -3);
      }
      cuerpoFormateado = cuerpo + cuerpoFormateado;
      this.value = cuerpoFormateado + (dv ? '-' + dv : '');
    });
  }

  // Toggle mostrar/ocultar contrase√±a
  const toggles = document.querySelectorAll('.toggle-password');
  toggles.forEach(function(btn) {
    btn.addEventListener('click', function() {
      const targetId = this.getAttribute('data-target');
      const input = document.getElementById(targetId);
      if (!input) return;
      const isPassword = input.type === 'password';
      input.type = isPassword ? 'text' : 'password';
      this.textContent = isPassword ? 'üôà' : 'üëÅ';
    });
  });
});
</script>
{% endblock %}