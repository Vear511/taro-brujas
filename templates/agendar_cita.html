{% extends 'base.html' %}

{% block content %}
<div class="container-fluid mt-5 pt-5" style="background: linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 50%, #0a0a0a 100%); min-height: 100vh; position: relative; overflow: hidden;">
    <!-- Elemento decorativo de fondo -->
    <div class="bg-decoration"></div>
    
    <div class="row mb-5">
        <div class="col-12 text-center">
            <h1 class="hero-title display-3 fw-bold text-uppercase" style="color: #d4af37; text-shadow: 0 0 20px rgba(212, 175, 55, 0.8); letter-spacing: 3px; animation: fadeInUp 1s ease-out;">
                üìÖ Gesti√≥n de Disponibilidad
            </h1>
            <p class="lead mt-3" style="font-size: 1.2rem; color: #f5e6b3; text-shadow: 0 2px 6px rgba(0,0,0,0.7);">
              Selecciona un horario disponible para reservar tu experiencia m√≠stica.
            </p>
            <hr class="gold-line mx-auto mt-4">
        </div>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-10 mb-5">
            <div class="card-premium p-5 shadow-lg" style="background: linear-gradient(145deg, #181818 0%, #222 100%); border: 2px solid #d4af37; border-radius: 24px; box-shadow: 0 10px 40px rgba(212, 175, 55, 0.3);">
                <div id="tarotistaLegend" class="d-flex flex-wrap gap-2 align-items-center mb-3" style="min-height: 24px;"></div>
                <div id="calendar" class="calendar-premium"></div>
            </div>
        </div>
    </div>

    <!-- Modal de selecci√≥n de servicio (Mejorado) -->
    <div class="modal fade" id="modalServicio" tabindex="-1" aria-labelledby="modalServicioLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl">
            <div class="modal-content" style="border-radius: 24px; background: linear-gradient(145deg, #181818 0%, #222 100%); border: 2px solid #d4af37; box-shadow: 0 15px 50px rgba(212, 175, 55, 0.4);">
                <div class="modal-header bg-gradient text-gold text-center py-4">
                    <h3 class="modal-title w-100 fw-bold" id="modalServicioLabel" style="font-size: 2rem; text-shadow: 0 0 15px rgba(212, 175, 55, 0.8);">
                        ‚ú® Selecciona el Tipo de Servicio M√≠stico ‚ú®
                    </h3>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                </div>
                <div class="modal-body bg-dark text-light p-5">
                    <form id="formServicio">
                        <div class="row g-4">
                            <div class="col-12 col-md-6 col-lg-3">
                                <div class="card service-option h-100 p-4 text-center shadow-lg" data-servicio="basico" style="cursor: pointer; background: linear-gradient(145deg, #232323 0%, #2a2a2a 100%); border: 2px solid transparent; border-radius: 20px; transition: all 0.4s ease; transform: scale(1);">
                                    <div class="icon-large mb-3" style="font-size: 3rem; animation: pulse 2s infinite;">üîÆ</div>
                                    <h5 class="text-gold fw-bold">Tarot B√°sico</h5>
                                    <p class="small text-muted mb-2">30 minutos de revelaciones</p>
                                    <p class="h4 text-gold mb-0 fw-bold" style="text-shadow: 0 0 10px rgba(212, 175, 55, 0.6);">$15.000</p>
                                </div>
                            </div>
                            <div class="col-12 col-md-6 col-lg-3">
                                <div class="card service-option h-100 p-4 text-center shadow-lg" data-servicio="completo" style="cursor: pointer; background: linear-gradient(145deg, #232323 0%, #2a2a2a 100%); border: 2px solid transparent; border-radius: 20px; transition: all 0.4s ease; transform: scale(1);">
                                    <div class="icon-large mb-3" style="font-size: 3rem; animation: pulse 2s infinite;">üí´</div>
                                    <h5 class="text-gold fw-bold">Tarot Completo</h5>
                                    <p class="small text-muted mb-2">30 minutos de profundidad</p>
                                    <p class="h4 text-gold mb-0 fw-bold" style="text-shadow: 0 0 10px rgba(212, 175, 55, 0.6);">$25.000</p>
                                </div>
                            </div>
                            <div class="col-12 col-md-6 col-lg-3">
                                <div class="card service-option h-100 p-4 text-center shadow-lg" data-servicio="amor" style="cursor: pointer; background: linear-gradient(145deg, #232323 0%, #2a2a2a 100%); border: 2px solid transparent; border-radius: 20px; transition: all 0.4s ease; transform: scale(1);">
                                    <div class="icon-large mb-3" style="font-size: 3rem; animation: pulse 2s infinite;">‚ù§Ô∏è</div>
                                    <h5 class="text-gold fw-bold">Tarot del Amor</h5>
                                    <p class="small text-muted mb-2">30 minutos de conexiones</p>
                                    <p class="h4 text-gold mb-0 fw-bold" style="text-shadow: 0 0 10px rgba(212, 175, 55, 0.6);">$20.000</p>
                                </div>
                            </div>
                            <div class="col-12 col-md-6 col-lg-3">
                                <div class="card service-option h-100 p-4 text-center shadow-lg" data-servicio="karmico" style="cursor: pointer; background: linear-gradient(145deg, #232323 0%, #2a2a2a 100%); border: 2px solid transparent; border-radius: 20px; transition: all 0.4s ease; transform: scale(1);">
                                    <div class="icon-large mb-3" style="font-size: 3rem; animation: pulse 2s infinite;">üåô</div>
                                    <h5 class="text-gold fw-bold">Tarot K√°rmico</h5>
                                    <p class="small text-muted mb-2">30 minutos de destino</p>
                                    <p class="h4 text-gold mb-0 fw-bold" style="text-shadow: 0 0 10px rgba(212, 175, 55, 0.6);">$30.000</p>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer bg-gradient py-4">
                    <button type="button" class="btn btn-secondary w-100 fw-bold py-3" data-bs-dismiss="modal" style="background: #555; border: none; border-radius: 12px; font-size: 1.1rem;">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
<!-- Footer decorativo -->
<div class="row mt-5">
    <div class="col-12 text-center">
        <hr class="gold-line mx-auto mb-4">
        <p style="font-style: italic; font-size: 1.1rem; color: #f5e6b3; text-shadow: 0 2px 6px rgba(0,0,0,0.7);">
            ‚ú® Descubre tu camino con elegancia y misterio ‚ú®
        </p>
    </div>
</div>
</div>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">

<style>
    body {
        background: #111 !important;
        color: #fff;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    .bg-decoration {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: radial-gradient(circle at 50% 50%, rgba(212, 175, 55, 0.05) 0%, transparent 70%);
        pointer-events: none;
        z-index: -1;
    }
    .card-premium {
        backdrop-filter: blur(20px);
    }
    .calendar-premium {
        min-height: 700px;
        background: linear-gradient(145deg, #1a1a1a 0%, #222 100%);
        border-radius: 20px;
        box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
        padding: 20px;
    }
    .fc-toolbar-title {
        color: #d4af37 !important;
        font-weight: bold !important;
        letter-spacing: 1px !important;
        font-size: 1.5rem !important;
    }
    .fc-event {
        border-radius: 12px !important;
        font-size: 1.1rem !important;
        font-weight: 600 !important;
        border: none !important;
        color: #fff !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3) !important;
        transition: transform 0.2s ease !important;
    }
    .fc-event:hover {
        transform: scale(1.05) !important;
    }
    .fc .fc-button {
        background: linear-gradient(145deg, #222 0%, #333 100%) !important;
        color: #d4af37 !important;
        border: 1px solid #d4af37 !important;
        border-radius: 10px !important;
        font-weight: 600 !important;
        transition: all 0.3s ease !important;
        box-shadow: 0 2px 8px rgba(212, 175, 55, 0.2) !important;
    }
    .fc .fc-button:hover, .fc .fc-button:focus {
        background: linear-gradient(145deg, #d4af37 0%, #b8860b 100%) !important;
        color: #222 !important;
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 16px rgba(212, 175, 55, 0.4) !important;
    }
    .modal-content {
        background: linear-gradient(145deg, #181818 0%, #222 100%) !important;
        color: #fff !important;
        border-radius: 24px !important;
        border: 2px solid #d4af37 !important;
        box-shadow: 0 15px 50px rgba(212, 175, 55, 0.4) !important;
    }
    .bg-gradient {
        background: linear-gradient(90deg, #222 0%, #d4af37 50%, #222 100%) !important;
    }
    .text-gold {
        color: #d4af37 !important;
    }
    .service-option {
        border: 2px solid transparent !important;
        transition: all 0.4s ease !important;
        transform: scale(1) !important;
    }
    .service-option:hover, .service-option:focus {
        border: 2px solid #d4af37 !important;
        box-shadow: 0 8px 24px rgba(212, 175, 55, 0.5) !important;
        background: linear-gradient(145deg, #2a2a2a 0%, #333 100%) !important;
        transform: scale(1.05) !important;
    }
    .icon-large {
        font-size: 3rem !important;
        transition: transform 0.3s ease !important;
    }
    .service-option:hover .icon-large {
        transform: scale(1.2) !important;
    }
    .gold-line {
        border: 1px solid #d4af37;
        width: 100px;
        opacity: 0.8;
    }
    @keyframes fadeInUp {
        from { opacity: 0; transform: translateY(30px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }

    /* Leyenda tarotistas */
    #tarotistaLegend .legend-pill {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(0, 0, 0, 0.25);
        border: 1px solid rgba(212, 175, 55, 0.35);
        color: #f5e6b3;
        font-size: 0.95rem;
        line-height: 1;
        backdrop-filter: blur(6px);
    }
    #tarotistaLegend .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 999px;
        display: inline-block;
        box-shadow: 0 0 0 2px rgba(0,0,0,0.25);
    }


</style>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
let eventoSeleccionadoId = null;

function mostrarModalServicio(eventoId) {
    eventoSeleccionadoId = eventoId;
    const modal = new bootstrap.Modal(document.getElementById('modalServicio'));
    modal.show();
}

// Manejar selecci√≥n de servicio y inicializar calendario
document.addEventListener('DOMContentLoaded', function() {
    // Event listeners para opciones de servicio
    document.querySelectorAll('.service-option').forEach(function(card) {
        card.addEventListener('click', function() {
            const servicio = this.dataset.servicio;
            reservarConServicio(eventoSeleccionadoId, servicio);
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalServicio'));
            if (modal) modal.hide();
        });
    });

    // Inicializar FullCalendar
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        locale: 'es',
        allDaySlot: false,
        slotDuration: '00:30:00',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'timeGridWeek,timeGridDay,listWeek'
        },
        events: '/calendario/horarios/',
        eventsSet: function(events) {
            const legendEl = document.getElementById('tarotistaLegend');
            if (!legendEl) return;

            const map = new Map();
            events.forEach(ev => {
                const isReserved = ev.extendedProps && ev.extendedProps.is_reserved;
                if (isReserved) return;
                const tid = ev.extendedProps ? ev.extendedProps.tarotista_id : null;
                if (!tid) return;
                const tname = ev.extendedProps.tarotista_nombre || ('Tarotista ' + tid);
                const color = ev.backgroundColor || ev.borderColor || '#28a745';
                map.set(String(tid), { nombre: tname, color });
            });

            legendEl.innerHTML = '';
            if (map.size === 0) return;

            const items = Array.from(map.values()).sort((a,b) => a.nombre.localeCompare(b.nombre, 'es'));
            items.forEach(item => {
                const pill = document.createElement('span');
                pill.className = 'legend-pill';

                const dot = document.createElement('span');
                dot.className = 'legend-dot';
                dot.style.backgroundColor = item.color;

                pill.appendChild(dot);
                pill.appendChild(document.createTextNode(item.nombre));
                legendEl.appendChild(pill);
            });
        },
        eventClick: function (info) {
            if (info.event.extendedProps.is_reserved) {
                alert('Este horario ya est√° reservado.');
                return;
            }
            mostrarModalServicio(info.event.id);
        },
        eventDidMount: function (info) {
            if (info.event.extendedProps && info.event.extendedProps.is_reserved) {
                info.el.style.backgroundColor = '#dc3545';
                info.el.style.borderColor = '#dc3545';
            } else {
                // Disponible: respetar color que viene del backend (por tarotista)
                const c = info.event.backgroundColor || info.event.borderColor || '#28a745';
                info.el.style.backgroundColor = c;
                info.el.style.borderColor = c;
            }
        }
    });
    globalThis.calendar = calendar;
    calendar.render();
});

function reservarConServicio(eventoId, servicio) {
    fetch('/calendario/reservar/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            evento_id: eventoId,
            servicio: servicio
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const event = globalThis.calendar.getEventById(eventoId);
            if (event) {
                event.setProp('title', 'Ocupado');
                event.setExtendedProp('is_reserved', true);
                event.setProp('color', '#dc3545');
            }
            if (globalThis.calendar && typeof globalThis.calendar.refetchEvents === 'function') {
                globalThis.calendar.refetchEvents();
            }
            alert('Horario reservado correctamente.');
        } else {
            alert(data.error || 'No se pudo reservar.');
        }
    });
}
</script>

{% endblock %}
