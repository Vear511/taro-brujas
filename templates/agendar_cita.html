{% extends 'base.html' %}

{% block content %}
<div class="container mt-5 pt-4">

    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="hero-title">ðŸ“… Agendar Cita</h1>
            <p class="text-muted">
                Selecciona un horario disponible y el tipo de servicio.
            </p>
        </div>
    </div>

    <div class="row">
        <!-- PANEL CONFIRMACIÃ“N -->
        <div class="col-lg-4 mb-4">
            <div class="card-minimal p-4">
                <h4 class="text-gold mb-3">ðŸ”® Confirmar Servicio</h4>

                <form id="form-cita">
                    {% csrf_token %}
                    <input type="hidden" id="horario-id">

                    <div class="mb-3">
                        <label class="form-label text-light">Horario</label>
                        <input type="text" id="horario-info" class="form-control" readonly>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-light">Servicio</label>
                        <select id="servicio" class="form-control" required>
                            <option value="">Selecciona un servicio</option>
                            {% for servicio in servicios %}
                                <option value="{{ servicio.id }}"
                                        data-precio="{{ servicio.precio }}">
                                    {{ servicio.nombre }} â€“ ${{ servicio.precio }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label text-light">Precio</label>
                        <input type="text" id="precio" class="form-control" readonly>
                    </div>

                    <button type="submit" class="btn btn-gold w-100" disabled>
                        Confirmar Cita
                    </button>
                </form>
            </div>
        </div>

        <!-- CALENDARIO -->
        <div class="col-lg-8 mb-4">
            <div class="card-minimal p-4">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
let calendar;
const reservarUrl = "{% url 'citas:reservar_cita_ajax' %}";

document.addEventListener('DOMContentLoaded', function () {
    const calendarEl = document.getElementById('calendar');
    const eventos = JSON.parse('{{ horarios_eventos_json|safe }}');

    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        locale: 'es',
        allDaySlot: false,
        events: eventos,

        eventClick(info) {
            document.getElementById('horario-id').value = info.event.id;
            document.getElementById('horario-info').value =
                info.event.startStr.slice(0,16).replace('T',' ') +
                ' - ' +
                info.event.endStr.slice(11,16);

            document.querySelector('#form-cita button').disabled = false;
        },

        eventDidMount(info) {
            info.el.style.backgroundColor = '#28a745';
        }
    });

    calendar.render();
});

// Actualizar precio
document.getElementById('servicio').addEventListener('change', function () {
    const precio = this.options[this.selectedIndex].dataset.precio || '';
    document.getElementById('precio').value = precio ? `$${precio}` : '';
});

// Enviar reserva
document.getElementById('form-cita').addEventListener('submit', function (e) {
    e.preventDefault();

    fetch(reservarUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            horario_id: document.getElementById('horario-id').value,
            servicio_id: document.getElementById('servicio').value
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('Cita agendada correctamente');
            location.reload();
        } else {
            alert(data.error);
        }
    });
});
</script>
{% endblock %}
