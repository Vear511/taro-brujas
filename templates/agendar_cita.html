{% extends 'base.html' %}

{% block content %}
<div class="container mt-5 pt-4">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="hero-title">游늰 Gesti칩n de Disponibilidad</h1>
            <p class="text-muted">Visualiza los horarios y haz click para reservar un servicio de tarot.</p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8 mb-4">
            <div class="card-minimal p-4">
                <div id="calendar"></div>
            </div>
        </div>
    </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
// ----------------------------
// FUNCIONES DE SIMULACI칍N
// ----------------------------
function generarHorariosAleatorios(dias=5) {
    const eventos = [];
    const servicios = ["Tarot B치sico", "Tarot Completo", "Tarot del Amor", "Tarot K치rmico"];
    
    const hoy = new Date();
    
    for(let i=0; i<dias; i++) {
        const dia = new Date(hoy);
        dia.setDate(hoy.getDate() + i);

        const diaStr = dia.toISOString().split('T')[0]; // YYYY-MM-DD
        
        // Generar entre 3 y 6 horarios aleatorios por d칤a
        const cantidad = Math.floor(Math.random()*4) + 3;
        for(let j=0; j<cantidad; j++) {
            // Hora entre 9 y 16, incrementos de 30 min
            let hora = 9 + Math.floor(Math.random()*14)/2;
            const startHour = Math.floor(hora).toString().padStart(2,'0');
            const startMinute = (hora % 1 === 0) ? '00' : '30';
            const endTime = hora + 0.5;
            const endHour = Math.floor(endTime).toString().padStart(2,'0');
            const endMinute = (endTime % 1 === 0) ? '00' : '30';

            const start = `${diaStr}T${startHour}:${startMinute}:00`;
            const end = `${diaStr}T${endHour}:${endMinute}:00`;

            eventos.push({
                id: `event-${i}-${j}`,
                title: 'Disponible',
                start: start,
                end: end,
                color: '#28a745',
                extendedProps: { is_reserved: false }
            });
        }
    }

    return eventos;
}

// ----------------------------
// INICIALIZACI칍N DE FULLCALENDAR
// ----------------------------
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');

    // Horarios aleatorios para 5 d칤as
    var eventos = generarHorariosAleatorios(5);

    // Lista de servicios de tarot
    const servicios = [
        {nombre: "Tarot B치sico", duracion: 30, precio: 15000},
        {nombre: "Tarot Completo", duracion: 60, precio: 25000},
        {nombre: "Tarot del Amor", duracion: 45, precio: 20000},
        {nombre: "Tarot K치rmico", duracion: 90, precio: 30000},
    ];

    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        locale: 'es',
        allDaySlot: false,
        slotDuration: '00:30:00',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'timeGridWeek,timeGridDay,listWeek'
        },
        events: eventos,
        selectable: false,

        eventClick: function(info) {
            if(!info.event.extendedProps.is_reserved) {
                // Crear lista de opciones
                let opciones = servicios.map((s,i) => `${i+1}. ${s.nombre} - $${s.precio} - ${s.duracion} min`).join('\n');
                let seleccion = prompt(`Selecciona el servicio:\n${opciones}`);
                let index = parseInt(seleccion) - 1;
                if(!isNaN(index) && index>=0 && index<servicios.length) {
                    info.event.setProp('title', `Ocupado (${servicios[index].nombre})`);
                    info.event.setExtendedProp('is_reserved', true);
                    info.event.setProp('color', '#dc3545');
                    alert(`Has reservado: ${servicios[index].nombre}`);
                } else {
                    alert('Selecci칩n inv치lida.');
                }
            } else {
                alert('Este horario ya est치 ocupado.');
            }
        },

        eventDidMount: function(info) {
            if(info.event.extendedProps.is_reserved) {
                info.el.style.backgroundColor = '#dc3545';
                info.el.style.borderColor = '#dc3545';
            } else {
                info.el.style.backgroundColor = '#28a745';
                info.el.style.borderColor = '#28a745';
            }
        }
    });

    calendar.render();
});
</script>

<style>
.fc .fc-toolbar-title {
    color: var(--accent-gold);
    font-weight: 600;
}

.fc {
    background: var(--bg-card);
    border-radius: 12px;
    padding: 1rem;
}

.fc-event {
    border-radius: 8px;
    color: #fff;
    font-weight: 500;
    cursor: pointer;
    border: none !important;
    padding: 5px;
}

.card-minimal {
    background: var(--bg-card);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    backdrop-filter: blur(10px);
}
</style>

{% endblock %}
