{% extends 'base.html' %}

{% block content %}
<div class="container mt-5 pt-4">
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="hero-title"> Calendario de Disponibilidad</h1>
            <p class="text-muted">Marca tus horarios disponibles para que los clientes puedan agendar citas.</p>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="card-minimal text-center p-3">
                <h5 class="text-gold">Total Horarios</h5>
                <p class="text-light display-6">{{ total_horarios|default:'0' }}</p> 
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card-minimal text-center p-3">
                <h5 class="text-gold">Disponibles</h5>
                <p class="text-light display-6">{{ horarios_disponibles|default:'0' }}</p>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card-minimal text-center p-3">
                <h5 class="text-gold">Reservados</h5>
                <p class="text-light display-6">{{ horarios_reservados|default:'0' }}</p>
            </div>
        </div>
    </div>

    <div class="card-minimal p-4">
        <div id="calendar"></div>
    </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    // 1. Convertir horarios de Django a JS
    // **NOTA IMPORTANTE:** La variable 'horarios_eventos_json' DEBE ser pasada desde la vista de Django
    // como una cadena JSON de la lista de eventos. Ejemplo en Django view:
    // context['horarios_eventos_json'] = json.dumps(list_of_events)
    // donde list_of_events es una lista de diccionarios en formato FullCalendar.
    // Ejemplo de evento: {'id': 1, 'title': 'Disponible', 'start': '2025-01-01T10:00:00', 'end': '2025-01-01T11:00:00', 'color': '#28a745'}
    var eventos = JSON.parse('{{ horarios_eventos_json|safe }}' || '[]');

    // Funci贸n para obtener el CSRF token de Django
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');


    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        locale: 'es',
        allDaySlot: false,
        slotMinTime: "08:00:00",
        slotMaxTime: "20:00:00",
        slotDuration: '01:00:00', // Define la duraci贸n de las ranuras (ej. 1 hora)
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'timeGridWeek,timeGridDay,listWeek'
        },
        events: eventos,
        selectable: true,
        select: function(info) {
            // Se ejecuta al seleccionar un rango de tiempo
            let start = info.startStr.slice(0, 16); // Formato YYYY-MM-DDTHH:MM
            let end = info.endStr.slice(0, 16);

            let confirmar = confirm(`驴Deseas marcar este horario como disponible?\nDesde: ${start.replace('T', ' ')}\nHasta: ${end.replace('T', ' ')}`);
            
            if (confirmar) {
                // **2. Implementaci贸n AJAX para marcar disponibilidad (Crear Evento)**
                fetch('/tu-url-de-marcar-disponibilidad/', { // **Cambia esta URL**
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken 
                    },
                    body: JSON.stringify({
                        start_time: start,
                        end_time: end,
                        action: 'add'
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if(data.success) {
                        // Si la operaci贸n en Django es exitosa, se a帽ade el evento al calendario
                        calendar.addEvent({
                            id: data.event_id, // Necesitas devolver el ID del evento creado
                            title: 'Disponible',
                            start: start,
                            end: end,
                            color: '#28a745' // Verde para disponible
                        });
                        alert('Horario marcado como disponible.');
                    } else {
                        alert('Error al marcar disponibilidad: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error en la petici贸n AJAX:', error);
                    alert('Ocurri贸 un error de conexi贸n.');
                });
            }
            calendar.unselect(); // Deselecciona el rango
        },
        eventClick: function(info) {
            // Se ejecuta al hacer clic en un evento existente
            if(info.event.title === "Disponible" && !info.event.extendedProps.is_reserved) { 
                // Evita eliminar eventos ya reservados
                let confirmar = confirm(`驴Deseas eliminar este horario disponible?\nID: ${info.event.id}`);
                
                if (confirmar) {
                    // **3. Implementaci贸n AJAX para eliminar disponibilidad (Eliminar Evento)**
                    fetch('/tu-url-de-marcar-disponibilidad/', { // **Cambia esta URL**
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': csrftoken 
                        },
                        body: JSON.stringify({
                            event_id: info.event.id,
                            action: 'delete'
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if(data.success) {
                            info.event.remove(); // Elimina el evento del calendario
                            alert('Horario eliminado correctamente.');
                        } else {
                            alert('Error al eliminar horario: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error en la petici贸n AJAX:', error);
                        alert('Ocurri贸 un error de conexi贸n.');
                    });
                }
            } else if (info.event.extendedProps.is_reserved) {
                 alert('Este horario ya est谩 reservado y no puede ser eliminado directamente.');
            }
        },
        eventDidMount: function(info) {
            // Para cambiar el color de los eventos 'Reservados'
            if (info.event.extendedProps.is_reserved) {
                 info.el.style.backgroundColor = '#dc3545'; // Rojo para reservados
                 info.el.style.borderColor = '#dc3545'; 
            } else {
                 info.el.style.backgroundColor = '#28a745'; // Verde para disponibles
                 info.el.style.borderColor = '#28a745'; 
            }
        }
    });

    calendar.render();
});
</script>

<style>
/* Estilos adicionales para FullCalendar, tal vez puedes ponerlos en un archivo CSS */
.fc .fc-toolbar-title {
    color: var(--accent-gold);
    font-weight: 600;
}

.fc {
    background: var(--bg-card);
    border-radius: 12px;
    padding: 1rem;
}

.fc-event {
    border-radius: 8px;
    color: #fff;
    font-weight: 500;
    cursor: pointer;
    border: none !important; /* Eliminamos el borde por defecto para usar solo el background-color */
    padding: 5px;
}

.card-minimal {
    background: var(--bg-card);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 12px;
    backdrop-filter: blur(10px);
}

/* Colores para las tarjetas de resumen (ajusta a tus variables CSS) */
.text-gold { color: #FFD700; } 
.text-light { color: #f8f9fa; }
</style>
{% endblock %}
