<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Disponibilidad - Brujitas</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Crimson+Text&display=swap" rel="stylesheet">
    
    {% load static %}
    <link href="{% static 'css/styles.css' %}" rel="stylesheet"> 
    
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    
    <style>
        /* Estilos espec√≠ficos de FullCalendar (Asegura visibilidad en tema oscuro) */
        
        /* Estilo para los eventos de disponibilidad (mantenemos el verde para contraste) */
        .fc-event-available {
            background-color: #34d399 !important; /* Green 400 */
            border-color: #059669 !important; /* Green 600 */
            color: white !important;
            font-weight: 600;
        }

        /* Sobreescribir colores de FullCalendar para el tema oscuro usando tus variables */
        .fc-theme-dark .fc-toolbar-title {
            color: var(--text-light, #f0f0f0) !important;
        }
        .fc-theme-dark .fc-button {
            background-color: var(--bg-card, #1a1a1a) !important;
            border-color: var(--border-light, rgba(255,255,255,0.1)) !important;
            color: var(--text-light, #f0f0f0) !important;
        }
        .fc-theme-dark .fc-col-header-cell {
            background-color: var(--bg-card, #1a1a1a) !important;
            border-bottom: 1px solid var(--border-light, rgba(255,255,255,0.1)) !important;
            color: var(--text-light, #f0f0f0) !important;
        }

        /* Estilo de los selects para el tema oscuro */
        .form-select {
            background-color: #333;
            border-color: var(--border-light);
            color: var(--text-light);
            transition: border-color 0.15s ease-in-out;
        }
        .form-select:focus {
            background-color: #333;
            color: var(--text-light);
            border-color: var(--accent-gold, #d4af37); 
            box-shadow: 0 0 0 0.25rem rgba(212, 175, 55, 0.25); 
        }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.8/index.global.min.js"></script>
    
</head>
<body class="p-4 p-md-5">
    {% csrf_token %} 

    <div id="app" class="container-fluid" style="max-width: 900px;">
        <h1 class="text-center text-gold mb-4">üìÖ Gestor de Horarios Disponibles</h1>
        <p class="text-center text-muted mb-5">Usa los selectores para a√±adir un nuevo bloque de disponibilidad. Los horarios se actualizan en tiempo real en el calendario.</p>

        <div class="card-minimal p-4">
            <h2 class="h5 text-light mb-4">A√±adir Nuevo Horario</h2>
            <div id="loading-data" class="text-center text-purple mb-4 hidden">Cargando y sincronizando horarios con el servidor...</div>

            <div class="row g-3 align-items-end">
                <div class="col-6 col-md-2">
                    <label for="select-year" class="form-label mb-1">A√±o</label>
                    <select id="select-year" class="form-select"></select>
                </div>
                <div class="col-6 col-md-3">
                    <label for="select-month" class="form-label mb-1">Mes</label>
                    <select id="select-month" class="form-select"></select>
                </div>
                <div class="col-6 col-md-2">
                    <label for="select-day" class="form-label mb-1">D√≠a</label>
                    <select id="select-day" class="form-select"></select>
                </div>
                <div class="col-6 col-md-2">
                    <label for="select-start-time" class="form-label mb-1">Desde</label>
                    <select id="select-start-time" class="form-select"></select>
                </div>
                <div class="col-12 col-md-3">
                    <label for="select-end-time" class="form-label mb-1">Hasta</label>
                    <select id="select-end-time" class="form-select"></select>
                </div>
            </div>

            <button id="add-schedule-btn" class="mt-4 w-100 btn-gold">
                Guardar Horario Disponible
            </button>

            <div id="error-message" class="mt-3 text-danger fw-medium hidden"></div>
        </div>

        <div class="card-minimal p-4">
            <div id="calendar" class="w-100"></div>
        </div>
        
        <p class="text-small text-muted mt-4 text-center">Gesti√≥n de disponibilidad</p>

    </div>

    <script>
        
        // ------------------------------------------
        // 0. CONFIGURACI√ìN Y UTILIDADES DE DJANGO
        // ------------------------------------------
        
        // **IMPORTANTE:** Debes definir estas URLs en tu archivo urls.py de Django
        const URLS = {
            LOAD: '{% url "schedule:load_schedule" %}', // URL para GET (cargar)
            ADD: '{% url "schedule:add_schedule" %}',   // URL para POST (guardar)
            DELETE: '{% url "schedule:delete_schedule" %}', // URL base para DELETE (ej: /api/horarios/123/eliminar/)
        };

        // Funci√≥n utilitaria para obtener el token CSRF de Django
        function getCsrfToken() {
            const csrfToken = document.querySelector('[name="csrfmiddlewaretoken"]');
            return csrfToken ? csrfToken.value : '';
        }

        // Elementos del DOM
        const calendarEl = document.getElementById('calendar');
        const loadingDataEl = document.getElementById('loading-data');
        const errorMessageEl = document.getElementById('error-message');
        const addScheduleBtn = document.getElementById('add-schedule-btn');
        
        let calendar = null;

        function displayError(message) {
            errorMessageEl.textContent = message;
            errorMessageEl.classList.remove('hidden');
            setTimeout(() => errorMessageEl.classList.add('hidden'), 7000);
        }
        
        // ------------------------------------------
        // 1. GESTI√ìN DE FULLCALENDAR
        // ------------------------------------------
        
        function initCalendar() {
            if (!calendarEl || calendar) return;

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                locale: 'es',
                allDaySlot: false,
                slotMinTime: "07:00:00",
                slotMaxTime: "22:00:00",
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'timeGridWeek,timeGridDay'
                },
                events: fetchEventsFromDjango, // Usamos una funci√≥n para cargar eventos
                editable: false, 
                selectable: false, 
                
                // Manejar la eliminaci√≥n de un slot al hacer clic en √©l
                eventClick: function(info) {
                    // El ID del evento debe ser el PK (Primary Key) de tu modelo Django
                    const scheduleId = info.event.id; 
                    const confirmation = confirm(`¬øDeseas eliminar este horario disponible?\nDesde: ${info.event.startStr}\nHasta: ${info.event.endStr}`);
                    
                    if (confirmation) {
                        deleteSchedule(scheduleId);
                    }
                }
            });

            calendar.render();
        }
        
        // Funci√≥n para cargar eventos desde Django (Usada por FullCalendar)
        async function fetchEventsFromDjango(fetchInfo, successCallback, failureCallback) {
             loadingDataEl.classList.remove('hidden');
            try {
                // Fetch a tu endpoint de listado de horarios
                const response = await fetch(URLS.LOAD, {
                    method: 'GET',
                    headers: {
                        'X-CSRFToken': getCsrfToken(), // Incluir el token CSRF, aunque sea GET
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // Transformar los datos de Django al formato de FullCalendar
                const fcEvents = data.map(item => ({
                    // item.id debe ser el PK del modelo Django
                    id: item.id, 
                    title: 'Disponible',
                    start: item.inicio, // Ejemplo: '2025-12-01T10:00:00'
                    end: item.fin,       // Ejemplo: '2025-12-01T11:00:00'
                    classNames: ['fc-event-available'],
                    allDay: false
                }));
                
                successCallback(fcEvents);
                
            } catch (error) {
                console.error("Error al cargar horarios desde Django:", error);
                displayError("Error al cargar horarios: " + error.message);
                failureCallback(error);
            } finally {
                 loadingDataEl.classList.add('hidden');
            }
        }


        // ------------------------------------------
        // 2. COMUNICACI√ìN CON DJANGO (CREATE/DELETE)
        // ------------------------------------------

        // Guardar un nuevo horario (POST)
        async function saveSchedule(startTime, endTime) {
            loadingDataEl.classList.remove('hidden');
            try {
                const response = await fetch(URLS.ADD, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCsrfToken(),
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        inicio: startTime,
                        fin: endTime,
                        // Puedes a√±adir m√°s campos que necesite tu modelo de Django
                        // user_id: {{ request.user.id }}, 
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                // Si tiene √©xito, FullCalendar recarga autom√°ticamente los eventos
                if (calendar) {
                    calendar.refetchEvents();
                }
                alert('Horario disponible guardado con √©xito!');
                
            } catch (e) {
                console.error("Error al guardar en Django: ", e);
                displayError("Error al guardar el horario: " + e.message);
            } finally {
                loadingDataEl.classList.add('hidden');
            }
        }
        
        // Eliminar un horario (DELETE)
        async function deleteSchedule(scheduleId) {
            loadingDataEl.classList.remove('hidden');
            try {
                // Construir la URL de DELETE usando el ID del horario
                // (Ej: /api/horarios/123/eliminar/)
                const deleteUrl = URLS.DELETE.replace('0', scheduleId); 

                const response = await fetch(deleteUrl, {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': getCsrfToken(),
                        'Content-Type': 'application/json',
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                }

                // Si tiene √©xito, FullCalendar recarga autom√°ticamente los eventos
                if (calendar) {
                    calendar.refetchEvents();
                }
                alert('Horario disponible eliminado con √©xito.');
                
            } catch (e) {
                console.error("Error al eliminar en Django: ", e);
                displayError("Error al eliminar el horario: " + e.message);
            } finally {
                loadingDataEl.classList.add('hidden');
            }
        }

        // ------------------------------------------
        // 3. L√ìGICA DE FORMULARIO (Sin cambios, es l√≥gica pura JS)
        // ------------------------------------------

        const selectYear = document.getElementById('select-year');
        const selectMonth = document.getElementById('select-month');
        const selectDay = document.getElementById('select-day');
        const selectStartTime = document.getElementById('select-start-time');
        const selectEndTime = document.getElementById('select-end-time');

        const MONTHS_ES = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        function populateYears() {
            const currentYear = new Date().getFullYear();
            for (let i = 0; i < 3; i++) {
                const year = currentYear + i;
                selectYear.innerHTML += `<option value="${year}">${year}</option>`;
            }
        }

        function populateMonths() {
            selectMonth.innerHTML = '';
            MONTHS_ES.forEach((name, index) => {
                const monthValue = String(index + 1).padStart(2, '0');
                selectMonth.innerHTML += `<option value="${monthValue}">${name}</option>`;
            });
            const currentMonth = new Date().getMonth();
            selectMonth.value = String(currentMonth + 1).padStart(2, '0');
        }

        function getDaysInMonth(year, month) {
            return new Date(year, month, 0).getDate();
        }

        function populateDays() {
            selectDay.innerHTML = '';
            const year = parseInt(selectYear.value);
            const month = parseInt(selectMonth.value); 
            const daysInMonth = getDaysInMonth(year, month);

            for (let i = 1; i <= daysInMonth; i++) {
                const dayValue = String(i).padStart(2, '0');
                selectDay.innerHTML += `<option value="${dayValue}">${i}</option>`;
            }
            const currentDay = new Date().getDate();
            selectDay.value = String(currentDay).padStart(2, '0');
        }
        
        function populateTimes() {
            selectStartTime.innerHTML = '';
            selectEndTime.innerHTML = '';

            for (let h = 7; h <= 22; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const hour = String(h).padStart(2, '0');
                    const minute = String(m).padStart(2, '0');
                    const time = `${hour}:${minute}`;

                    if (h < 22) { 
                        selectStartTime.innerHTML += `<option value="${time}">${time}</option>`;
                    }
                    if (h > 7 || (h === 7 && m > 0)) { 
                        selectEndTime.innerHTML += `<option value="${time}">${time}</option>`;
                    }
                }
            }
            selectStartTime.value = "11:00";
            selectEndTime.value = "12:00";
        }

        function setupFormListeners() {
            populateYears();
            populateMonths();
            populateDays();
            populateTimes();

            selectYear.addEventListener('change', populateDays);
            selectMonth.addEventListener('change', populateDays);
            
            addScheduleBtn.addEventListener('click', () => {
                const year = selectYear.value;
                const month = selectMonth.value;
                const day = selectDay.value;
                const startTime = selectStartTime.value;
                const endTime = selectEndTime.value;

                const datePart = `${year}-${month}-${day}`;
                
                const startDateTimeString = `${datePart}T${startTime}:00`;
                const endDateTimeString = `${datePart}T${endTime}:00`;

                if (startDateTimeString >= endDateTimeString) {
                    displayError('La hora de inicio debe ser anterior a la hora de fin.');
                    return;
                }
                
                // Llamar a la funci√≥n de guardado en Django
                saveSchedule(startDateTimeString, endDateTimeString);
            });
        }
        
        // ------------------------------------------
        // 4. INICIO DE LA APLICACI√ìN
        // ------------------------------------------

        // Inicializar al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', () => {
            setupFormListeners();
            initCalendar();
            // FullCalendar llama a fetchEventsFromDjango internamente al renderizarse
        });


    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
