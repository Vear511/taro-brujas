<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GestiÃ³n de Disponibilidad - Brujitas</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Crimson+Text&display=swap" rel="stylesheet">
    
    <link href="{% static 'css/styles.css' %}" rel="stylesheet"> 
    
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
    
    <style>
        /* Estilos especÃ­ficos de FullCalendar (Asegura visibilidad en tema oscuro) */
        
        /* Estilo para los eventos de disponibilidad (mantenemos el verde para contraste) */
        .fc-event-available {
            background-color: #34d399 !important; /* Green 400 */
            border-color: #059669 !important; /* Green 600 */
            color: white !important;
            font-weight: 600;
        }

        /* Sobreescribir colores de FullCalendar para el tema oscuro usando tus variables */
        /* Si FullCalendar detecta el tema oscuro (que lo hace por defecto a veces), estos ayudan: */
        .fc-theme-dark .fc-toolbar-title {
            color: var(--text-light, #f0f0f0) !important;
        }
        .fc-theme-dark .fc-button {
            background-color: var(--bg-card, #1a1a1a) !important;
            border-color: var(--border-light, rgba(255,255,255,0.1)) !important;
            color: var(--text-light, #f0f0f0) !important;
        }
        .fc-theme-dark .fc-col-header-cell {
            background-color: var(--bg-card, #1a1a1a) !important;
            border-bottom: 1px solid var(--border-light, rgba(255,255,255,0.1)) !important;
            color: var(--text-light, #f0f0f0) !important;
        }

        /* Estilo de los selects para el tema oscuro */
        .form-select {
            background-color: #333;
            border-color: var(--border-light);
            color: var(--text-light);
            transition: border-color 0.15s ease-in-out;
        }
        .form-select:focus {
            background-color: #333;
            color: var(--text-light);
            /* Usamos tu color dorado para el focus */
            border-color: var(--accent-gold, #d4af37); 
            box-shadow: 0 0 0 0.25rem rgba(212, 175, 55, 0.25); 
        }
    </style>
    
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.8/index.global.min.js"></script>
    
</head>
<body class="p-4 p-md-5">

    <div id="app" class="container-fluid" style="max-width: 900px;">
        <h1 class="text-center text-gold mb-4">ðŸ“… Gestor de Horarios Disponibles</h1>
        <p class="text-center text-muted mb-5">Usa los selectores para aÃ±adir un nuevo bloque de disponibilidad. Los horarios se actualizan en tiempo real en el calendario.</p>

        <div class="card-minimal p-4">
            <h2 class="h5 text-light mb-4">AÃ±adir Nuevo Horario</h2>
            <div id="loading-auth" class="text-center text-purple mb-4 hidden">Inicializando la base de datos...</div>

            <div class="row g-3 align-items-end">
                <div class="col-6 col-md-2">
                    <label for="select-year" class="form-label mb-1">AÃ±o</label>
                    <select id="select-year" class="form-select"></select>
                </div>
                <div class="col-6 col-md-3">
                    <label for="select-month" class="form-label mb-1">Mes</label>
                    <select id="select-month" class="form-select"></select>
                </div>
                <div class="col-6 col-md-2">
                    <label for="select-day" class="form-label mb-1">DÃ­a</label>
                    <select id="select-day" class="form-select"></select>
                </div>
                <div class="col-6 col-md-2">
                    <label for="select-start-time" class="form-label mb-1">Desde</label>
                    <select id="select-start-time" class="form-select"></select>
                </div>
                <div class="col-12 col-md-3">
                    <label for="select-end-time" class="form-label mb-1">Hasta</label>
                    <select id="select-end-time" class="form-select"></select>
                </div>
            </div>

            <button id="add-schedule-btn" class="mt-4 w-100 btn-gold" disabled>
                Guardar Horario Disponible
            </button>

            <div id="error-message" class="mt-3 text-danger fw-medium hidden"></div>
        </div>

        <div class="card-minimal p-4">
            <div id="calendar" class="w-100"></div>
        </div>
        
        <p class="text-small text-muted mt-4 text-center">ID de Usuario: <span id="user-id-display">Cargando...</span> | ID de App: <span id="app-id-display">Cargando...</span></p>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            query, 
            onSnapshot, 
            deleteDoc, 
            doc,
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ConfiguraciÃ³n y variables globales del entorno Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        let calendar = null;
        const SCHEDULE_COLLECTION = 'available_slots';

        // Elementos del DOM
        const calendarEl = document.getElementById('calendar');
        const userIdDisplay = document.getElementById('user-id-display');
        const appIdDisplay = document.getElementById('app-id-display');
        const loadingAuthEl = document.getElementById('loading-auth');
        const errorMessageEl = document.getElementById('error-message');
        const addScheduleBtn = document.getElementById('add-schedule-btn');

        // FunciÃ³n de utilidad para mostrar errores
        function displayError(message) {
            errorMessageEl.textContent = message;
            errorMessageEl.classList.remove('hidden');
            setTimeout(() => errorMessageEl.classList.add('hidden'), 5000);
        }

        // 1. INICIALIZACIÃ“N DE FIREBASE Y AUTENTICACIÃ“N
        async function initFirebase() {
            loadingAuthEl.classList.remove('hidden');
            try {
                // Configurar el nivel de log para depuraciÃ³n (opcional)
                setLogLevel('debug'); 

                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                appIdDisplay.textContent = appId;

                // AutenticaciÃ³n con el token proporcionado o anÃ³nimamente
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Esperar a que el estado de autenticaciÃ³n cambie
                onAuthStateChanged(auth, (user) => {
                    loadingAuthEl.classList.add('hidden');
                    if (user) {
                        userId = user.uid;
                        userIdDisplay.textContent = userId;
                        addScheduleBtn.disabled = false;
                        // Una vez autenticado, inicializar el calendario y listeners de datos
                        initCalendar();
                        setupDataListener();
                        setupFormListeners();
                    } else {
                        userIdDisplay.textContent = 'No autenticado';
                        addScheduleBtn.disabled = true;
                        displayError('Error de autenticaciÃ³n. No se puede cargar el usuario.');
                    }
                });

            } catch (error) {
                loadingAuthEl.classList.add('hidden');
                console.error("Firebase Initialization/Auth Error:", error);
                displayError("Error crÃ­tico al inicializar Firebase: " + error.message);
                addScheduleBtn.disabled = true;
            }
        }

        // 2. CONFIGURACIÃ“N DE FIRESTORE
        function getCollectionRef() {
            // Usamos la colecciÃ³n privada por usuario
            return collection(db, `artifacts/${appId}/users/${userId}/${SCHEDULE_COLLECTION}`);
        }

        // 3. FULLCALENDAR
        function initCalendar() {
            if (!calendarEl || calendar) return; // Ya inicializado o elemento no encontrado

            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                locale: 'es',
                allDaySlot: false,
                slotMinTime: "07:00:00",
                slotMaxTime: "22:00:00",
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'timeGridWeek,timeGridDay'
                },
                editable: false, 
                selectable: false, 
                events: [], 
                eventContent: function(arg) {
                    return { html: '<div class="p-1 leading-tight">âœ… Disponible</div>' };
                },
                eventClick: function(info) {
                    const docId = info.event.id;
                    const confirmation = confirm(`Â¿Deseas eliminar este horario disponible?\nDesde: ${info.event.startStr}\nHasta: ${info.event.endStr}`);
                    
                    if (confirmation) {
                        deleteSchedule(docId);
                    }
                }
            });

            calendar.render();
        }

        // 4. LECTURA DE DATOS EN TIEMPO REAL (onSnapshot)
        function setupDataListener() {
            if (!db || !userId) return;

            const q = query(getCollectionRef());

            onSnapshot(q, (snapshot) => {
                const firebaseEvents = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    firebaseEvents.push({
                        id: doc.id, 
                        title: 'Disponible',
                        start: data.inicio,
                        end: data.fin,
                        classNames: ['fc-event-available'],
                        allDay: false
                    });
                });

                if (calendar) {
                    calendar.removeAllEvents();
                    calendar.addEventSource(firebaseEvents);
                    
                    if (firebaseEvents.length > 0) {
                        const initialDate = firebaseEvents[0].start.split('T')[0];
                        calendar.gotoDate(initialDate);
                    } else {
                        calendar.gotoDate(new Date());
                    }
                }
            }, (error) => {
                console.error("Error al escuchar datos de Firestore:", error);
                displayError("Error al cargar horarios: " + error.message);
            });
        }

        // 5. ESCRITURA de datos (ADD)
        async function saveSchedule(startTime, endTime) {
            if (!db || !userId) {
                displayError("Error: Usuario no autenticado para guardar datos.");
                return;
            }

            try {
                await addDoc(getCollectionRef(), {
                    inicio: startTime,
                    fin: endTime,
                    reservado: false, 
                    createdAt: new Date().toISOString()
                });
                alert('Horario disponible guardado con Ã©xito!');
            } catch (e) {
                console.error("Error adding document: ", e);
                displayError("Error al guardar el horario: " + e.message);
            }
        }
        
        // 6. ELIMINACIÃ“N DE DATOS (DELETE)
        async function deleteSchedule(docId) {
            if (!db || !userId) {
                displayError("Error: Usuario no autenticado para eliminar datos.");
                return;
            }

            try {
                await deleteDoc(doc(getCollectionRef(), docId));
                alert('Horario disponible eliminado con Ã©xito.');
            } catch (e) {
                console.error("Error deleting document: ", e);
                displayError("Error al eliminar el horario: " + e.message);
            }
        }


        // 7. LÃ“GICA DE FORMULARIO
        const selectYear = document.getElementById('select-year');
        const selectMonth = document.getElementById('select-month');
        const selectDay = document.getElementById('select-day');
        const selectStartTime = document.getElementById('select-start-time');
        const selectEndTime = document.getElementById('select-end-time');

        const MONTHS_ES = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        function populateYears() {
            const currentYear = new Date().getFullYear();
            for (let i = 0; i < 3; i++) {
                const year = currentYear + i;
                selectYear.innerHTML += `<option value="${year}">${year}</option>`;
            }
        }

        function populateMonths() {
            selectMonth.innerHTML = '';
            MONTHS_ES.forEach((name, index) => {
                const monthValue = String(index + 1).padStart(2, '0');
                selectMonth.innerHTML += `<option value="${monthValue}">${name}</option>`;
            });
            const currentMonth = new Date().getMonth();
            selectMonth.value = String(currentMonth + 1).padStart(2, '0');
        }

        function getDaysInMonth(year, month) {
            return new Date(year, month, 0).getDate();
        }

        function populateDays() {
            selectDay.innerHTML = '';
            const year = parseInt(selectYear.value);
            const month = parseInt(selectMonth.value); 
            const daysInMonth = getDaysInMonth(year, month);

            for (let i = 1; i <= daysInMonth; i++) {
                const dayValue = String(i).padStart(2, '0');
                selectDay.innerHTML += `<option value="${dayValue}">${i}</option>`;
            }
            const currentDay = new Date().getDate();
            selectDay.value = String(currentDay).padStart(2, '0');
        }
        
        function populateTimes() {
            selectStartTime.innerHTML = '';
            selectEndTime.innerHTML = '';

            for (let h = 7; h <= 22; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const hour = String(h).padStart(2, '0');
                    const minute = String(m).padStart(2, '0');
                    const time = `${hour}:${minute}`;

                    if (h < 22) { 
                        selectStartTime.innerHTML += `<option value="${time}">${time}</option>`;
                    }
                    if (h > 7 || (h === 7 && m > 0)) { 
                        selectEndTime.innerHTML += `<option value="${time}">${time}</option>`;
                    }
                }
            }
            selectStartTime.value = "11:00";
            selectEndTime.value = "12:00";
        }

        function setupFormListeners() {
            populateYears();
            populateMonths();
            populateDays();
            populateTimes();

            selectYear.addEventListener('change', populateDays);
            selectMonth.addEventListener('change', populateDays);
            
            addScheduleBtn.addEventListener('click', () => {
                const year = selectYear.value;
                const month = selectMonth.value;
                const day = selectDay.value;
                const startTime = selectStartTime.value;
                const endTime = selectEndTime.value;

                const datePart = `${year}-${month}-${day}`;
                
                const startDateTimeString = `${datePart}T${startTime}:00`;
                const endDateTimeString = `${datePart}T${endTime}:00`;

                if (startDateTimeString >= endDateTimeString) {
                    displayError('La hora de inicio debe ser anterior a la hora de fin.');
                    return;
                }
                
                saveSchedule(startDateTimeString, endDateTimeString);
            });
        }

        // Iniciar la aplicaciÃ³n al cargar el script
        initFirebase();

    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
